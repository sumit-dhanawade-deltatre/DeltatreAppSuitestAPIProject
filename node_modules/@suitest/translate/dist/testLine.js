"use strict";var __read=this&&this.__read||function(t,e){var s="function"==typeof Symbol&&t[Symbol.iterator];if(!s)return t;var n,r,l=s.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(n=l.next()).done;)a.push(n.value)}catch(t){r={error:t}}finally{try{n&&!n.done&&(s=l.return)&&s.call(l)}finally{if(r)throw r.error}}return a};Object.defineProperty(exports,"__esModule",{value:!0}),exports.translateTestLine=void 0;var smst_1=require("@suitest/smst"),comparator_1=require("./comparator"),condition_1=require("./condition"),utils_1=require("./utils"),getConditionInfo=function(t,e){var s=t,n=s.condition,r=s.count,l=s.negateCondition,a=s.delay,i=function(t){return void 0!==t?smst_1.jsx("fragment",null," every ",utils_1.formatTimeout(t,null==e?void 0:e.configVariables)):""};return!n&&r&&("string"==typeof r||r>1)?smst_1.jsx("fragment",null," exactly ",utils_1.formatCount(r,null==e?void 0:e.configVariables),i(a)):n&&l?smst_1.jsx("text",null," only if condition is met"):n&&!l?smst_1.jsx("fragment",null," until condition is met max ",utils_1.formatCount(null!=r?r:1,null==e?void 0:e.configVariables),i(a)):void 0},assertAssertThen=function(t){throw new Error('Unknown "then" in assert: '+t)},translateAssertThen=function(t){switch(t){case"success":return"continue";case"exit":return"stop test";case"fail":return"fail";case"warning":return"warn";default:return assertAssertThen(t)}},translateAssertTestLine=function(t,e,s,n){var r=condition_1.translateCondition(t.condition,!(!t.then||"success"===(null==t?void 0:t.then)),e,s,n),l=t.excluded?"excluded":null==n?void 0:n.result;return smst_1.jsx("test-line",{title:smst_1.jsx("fragment",null,"Assert: ",r.title,t.timeout?smst_1.jsx("fragment",null," timeout ",utils_1.formatTimeout(t.timeout,null==e?void 0:e.configVariables)):void 0,t.then&&"success"!==t.then?smst_1.jsx("fragment",null," then ",translateAssertThen(t.then)):void 0),status:l},r.children)},translateTakeScreenshotTestLine=function(t,e){var s="";return"raw"===t.dataFormat?s="Take screenshot (raw)":"base64"===t.dataFormat?s="Take screenshot (base64)":t.fileName&&(s='Save screenshot ("'+t.fileName+'")'),smst_1.jsx("test-line",{title:smst_1.jsx("text",null,s),status:null==e?void 0:e.result})},translateClearAppDataTestLine=function(t,e){return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Clear application data"),status:t.excluded?"excluded":null==e?void 0:e.result})},stringifySelector=function(t){return Array.isArray(t)?t.map((function(t){return"|"+stringifySelector(t)+"|"})).join(" -> "):t.video||t.psVideo?"video element":t.active?"active element":t.handle?'element by handle "'+t.handle+'"':"string"==typeof t.linkText?'link with "'+t.linkText+'" text':"string"==typeof t.partialLinkText?'link containing "'+t.partialLinkText+'" text':'"'+Object.values(t).filter(Boolean)[0]+'" element'},translateQueryTestLine=function(t,e){var s="";switch(t.subject.type){case"cookie":s='Retrieve value for "'+t.subject.cookieName+'" cookie';break;case"execute":s='Retrieve value of execution "'+t.subject.execute+'"';break;case"location":s="Retrieve value of current location";break;case"elementProps":s="Retrieve info of "+stringifySelector(t.subject.selector);break;case"elementCssProps":var n=t.subject,r=n.elementCssProps,l=n.selector;s+="Getting ["+r.join(", ")+"] css properties of "+stringifySelector(l);break;case"elementHandle":s+="Getting handle"+(t.subject.multiple?"s":"")+" of "+stringifySelector(t.subject.selector);break;case"elementAttributes":var a=t.subject.attributes;s+="Getting "+(a.length?"["+a.join(", ")+"] attribute"+(a.length>1?"s":""):"all attributes")+" of "+stringifySelector(t.subject.selector);break;case"ocr":s+="Getting OCR result";break;default:var i=t.subject;console.warn('Unknown subject "'+JSON.stringify(i)+'" of query line.')}var o="error"===(null==e?void 0:e.result)?"fail":null==e?void 0:e.result;return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,s),status:o})},translateExecuteCommandTestLine=function(t,e,s){return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Execute JavaScript expression"),status:t.excluded?"excluded":null==s?void 0:s.result},smst_1.jsx("props",null,utils_1.translateCodeProp(smst_1.jsx("text",null,"JavaScript expression"),t.val,e,"",utils_1.mapStatus(null==s?void 0:s.result))))},translateOpenApp=function(t,e,s){var n,r=t.excluded?"excluded":null==s?void 0:s.result;if(t.launchMode){var l=null!==(n={resume:"Resume background application",restart:"Restart application"}[t.launchMode])&&void 0!==n?n:"Open application";return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,l),status:r})}if(t.deepLink)return smst_1.jsx("test-line",{title:"Open application at deep link "+t.deepLink,status:r});if(!t.relativeUrl)return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Open application"),status:r});var a=utils_1.formatVariables(t.relativeUrl,null==e?void 0:e.configVariables);return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Open application at relative URL"),status:r},smst_1.jsx("props",null,smst_1.jsx("prop",{name:smst_1.jsx("text",null,"relative path"),comparator:comparator_1.translateComparator("="),expectedValue:a})))},translateCloseAppTestLine=function(t,e){var s=t.excluded?"excluded":null==e?void 0:e.result;return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Close application"),status:s})},translateSuspendAppTestLine=function(t,e){var s=t.excluded?"excluded":null==e?void 0:e.result;return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Suspend application"),status:s})},translateOpenUrl=function(t,e,s){var n=utils_1.formatVariables(t.url,null==e?void 0:e.configVariables),r=t.excluded?"excluded":null==s?void 0:s.result;return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Open URL"),status:r},smst_1.jsx("props",null,smst_1.jsx("prop",{name:smst_1.jsx("text",null,"URL"),comparator:comparator_1.translateComparator("="),expectedValue:n})))},translateOpenDeepLink=function(t,e,s){var n=utils_1.formatVariables(t.deepLink,null==e?void 0:e.configVariables),r=t.excluded?"excluded":null==s?void 0:s.result;return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Open Deep Link"),status:r},smst_1.jsx("props",null,smst_1.jsx("prop",{name:smst_1.jsx("text",null,"Deep Link"),comparator:comparator_1.translateComparator("="),expectedValue:n})))},translateSleepTestLine=function(t,e,s){var n=t.excluded?"excluded":null==s?void 0:s.result,r=smst_1.jsx("fragment",null,"Sleep ",utils_1.formatTimeout(t.timeout,null==e?void 0:e.configVariables));return smst_1.jsx("test-line",{title:r,status:n})},translatePollUrlTestLine=function(t,e,s){var n=utils_1.formatVariables(t.response,null==e?void 0:e.configVariables),r=utils_1.formatVariables(t.url,null==e?void 0:e.configVariables),l=t.excluded?"excluded":null==s?void 0:s.result;return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Poll URL every 0.5s"),status:l},smst_1.jsx("props",null,smst_1.jsx("prop",{name:smst_1.jsx("text",null,"poll URL"),comparator:comparator_1.translateComparator("="),expectedValue:r,status:utils_1.mapStatus(null==s?void 0:s.result)}),smst_1.jsx("prop",{name:smst_1.jsx("text",null,"until receive"),comparator:comparator_1.translateComparator("="),expectedValue:n,status:utils_1.mapStatus(null==s?void 0:s.result)})))},translatePressButtonTestLine=function(t,e,s,n){var r=t.ids.map((function(e,s){return smst_1.jsx("fragment",null,smst_1.jsx("input",null,e),s!==t.ids.length-1?", ":"")})),l=getConditionInfo(t,e),a=t.excluded?"excluded":null==n?void 0:n.result,i=t.longPressMs?smst_1.jsx("fragment",null,"Press long ",r," for ",t.longPressMs,"ms ",l):smst_1.jsx("fragment",null,"Press ",r,l);return smst_1.jsx("test-line",{title:i,status:a},t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0)},translateTestName=function(t,e){return e&&e[t]?smst_1.jsx("subject",null,e[t].name):smst_1.jsx("fragment",null,"(",smst_1.jsx("code",null,t.slice(0,4)+"..."+t.slice(-4)),")")},translateRunTestTestLine=function(t,e,s,n,r){var l=translateTestName(t.val,n),a=getConditionInfo(t,e),i=t.excluded?"excluded":null==r?void 0:r.result;return smst_1.jsx("test-line",{title:smst_1.jsx("fragment",null,"Run test ",l,a),status:i},t.condition?condition_1.translateCondition(t.condition,!1,e,s,r):void 0)},assertUnknownTarget=function(t){throw new Error("Unknown target: "+JSON.stringify(t))},translateTarget=function(t){switch(t.type){case"element":return"val"in t&&t.val.active?smst_1.jsx("subject",null,"active element"):smst_1.jsx("subject",null,"element");case"window":return smst_1.jsx("subject",null,"coordinates"in t?t.relative?"relative position":"position":"window");case"screen":return smst_1.jsx("subject",null,"coordinates"in t?"position":"screen");default:return assertUnknownTarget(t)}},translateSendTextTestLine=function(t,e,s,n){var r=utils_1.formatVariables(t.val,null==e?void 0:e.configVariables),l=t.excluded?"excluded":null==n?void 0:n.result,a=getConditionInfo(t,e),i=smst_1.jsx("fragment",null,"Send text ",r," to ",translateTarget(t.target),a);return smst_1.jsx("test-line",{title:i,status:l},t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0)},translateSetTextTestLine=function(t,e,s,n){var r=utils_1.formatVariables(t.val,null==e?void 0:e.configVariables),l=getConditionInfo(t,e),a=t.excluded?"excluded":null==n?void 0:n.result,i=smst_1.jsx("fragment",null,"Set text ",r," to ",translateTarget(t.target),l);return smst_1.jsx("test-line",{title:i,status:a},t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0)},assertUnknownBrowserCommand=function(t){throw new Error("Unknown browser command: "+JSON.stringify(t))},assertUnknownDeviceSetting=function(t){throw new Error("Unknown device setting: "+JSON.stringify(t))},translateBrowserCommandTestLine=function(t,e,s,n){var r=t.excluded?"excluded":null==n?void 0:n.result,l=t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0;switch(t.browserCommand.type){case"goBack":return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Go back"),status:r},l);case"goForward":return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Go forward"),status:r},l);case"refresh":return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Refresh"),status:r},l);case"setWindowSize":return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Resize window"),status:r},smst_1.jsx("props",null,smst_1.jsx("prop",{name:smst_1.jsx("text",null,"size"),comparator:comparator_1.translateComparator("="),expectedValue:smst_1.jsx("text",null,String(t.browserCommand.params.width),"x",String(t.browserCommand.params.height))})),l);case"dismissAlertMessage":return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Dismiss modal dialog"),status:r},l);case"acceptAlertMessage":return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Accept modal dialog"),status:r},l);case"acceptPromptMessage":return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,"Accept modal dialog with message"),status:r},smst_1.jsx("props",null,smst_1.jsx("prop",{name:smst_1.jsx("text",null,"message"),comparator:comparator_1.translateComparator("="),expectedValue:smst_1.jsx("text",null,t.browserCommand.params.text)})),l);default:return assertUnknownBrowserCommand(t.browserCommand)}},translateDeviceSettingsTestLine=function(t,e,s,n){var r=t.excluded?"excluded":null==n?void 0:n.result,l=t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0;switch(t.deviceSettings.type){case"setOrientation":var a=utils_1.deviceOrientationsMap[t.deviceSettings.params.orientation];return smst_1.jsx("test-line",{title:smst_1.jsx("fragment",null,"Set screen orientation to ",smst_1.jsx("input",null,a)),status:r},l);default:return assertUnknownDeviceSetting(t.deviceSettings.type)}},translateClickTestLine=function(t,e,s,n){var r=getConditionInfo(t,e),l=smst_1.jsx("fragment",null,"Click on ",translateTarget(t.target),r),a=t.excluded?"excluded":null==n?void 0:n.result;return smst_1.jsx("test-line",{title:l,status:a},t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0)},translateTapTestLine=function(t,e,s,n){var r=getConditionInfo(t,e),l=__read(t.taps,1)[0],a=l.type,i=l.duration,o=a.charAt(0).toUpperCase()+a.slice(1),u=smst_1.jsx("fragment",null,o," tap on ",translateTarget(t.target),void 0!==i?smst_1.jsx("fragment",null," for ",utils_1.formatTimeout(i,null==e?void 0:e.configVariables)):void 0,r),c=t.excluded?"excluded":null==n?void 0:n.result;return smst_1.jsx("test-line",{title:u,status:c},t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0)},translateScrollTestLine=function(t,e,s,n){var r=getConditionInfo(t,e),l=t.scroll[0].direction,a=t.scroll[0].distance,i=smst_1.jsx("fragment",null,"Scroll from ",translateTarget(t.target),r," ",l,["string","number"].includes(typeof a)?" by "+a+"px":""),o=t.excluded?"excluded":null==n?void 0:n.result;return smst_1.jsx("test-line",{title:i,status:o},t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0)},translateSwipeTestLine=function(t,e,s,n){var r=getConditionInfo(t,e),l=t.swipe[0].direction,a=t.swipe[0].distance,i=t.swipe[0].duration,o=smst_1.jsx("fragment",null,"Swipe/Flick from ",translateTarget(t.target),r," ",l," by ",a,"px in ",i,"ms"),u=t.excluded?"excluded":null==n?void 0:n.result;return smst_1.jsx("test-line",{title:o,status:u},t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0)},translateMoveToTestLine=function(t,e,s,n){var r=getConditionInfo(t,e),l=smst_1.jsx("fragment",null,"Move pointer to ",translateTarget(t.target),r),a=t.excluded?"excluded":null==n?void 0:n.result;return smst_1.jsx("test-line",{title:l,status:a},t.condition?condition_1.translateCondition(t.condition,!1,e,s,n):void 0)},translateCommentTestLine=function(t){return smst_1.jsx("test-line",{title:smst_1.jsx("text",null,t.val.split("\n").map((function(t){return!!t.trim()&&"# "+t})).filter(Boolean).join("\n"))})},assertUnknownLineType=function(t){throw new Error("Unknown line type: "+JSON.stringify(t))};exports.translateTestLine=function(t){var e=t.testLine,s=t.appConfig,n=t.elements,r=t.snippets,l=t.lineResult;switch(e.type){case"query":return translateQueryTestLine(e,l);case"assert":case"wait":return translateAssertTestLine(e,s,n,l);case"takeScreenshot":return translateTakeScreenshotTestLine(e,l);case"clearAppData":return translateClearAppDataTestLine(e,l);case"execCmd":return translateExecuteCommandTestLine(e,s,l);case"openApp":return translateOpenApp(e,s,l);case"openUrl":return translateOpenUrl(e,s,l);case"openDeepLink":return translateOpenDeepLink(e,s,l);case"sleep":return translateSleepTestLine(e,s,l);case"pollUrl":return translatePollUrlTestLine(e,s,l);case"button":return translatePressButtonTestLine(e,s,n,l);case"runSnippet":return translateRunTestTestLine(e,s,n,r,l);case"sendText":return translateSendTextTestLine(e,s,n,l);case"setText":return translateSetTextTestLine(e,s,n,l);case"browserCommand":return translateBrowserCommandTestLine(e,s,n,l);case"deviceSettings":return translateDeviceSettingsTestLine(e,s,n,l);case"click":return translateClickTestLine(e,s,n,l);case"tap":return translateTapTestLine(e,s,n,l);case"scroll":return translateScrollTestLine(e,s,n,l);case"swipe":return translateSwipeTestLine(e,s,n,l);case"moveTo":return translateMoveToTestLine(e,s,n,l);case"closeApp":return translateCloseAppTestLine(e,l);case"suspendApp":return translateSuspendAppTestLine(e,l);case"comment":return translateCommentTestLine(e);default:return assertUnknownLineType(e)}};